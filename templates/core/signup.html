<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cadastre-se - Clube de Aventureiros</title>
    <style>
        :root { --gap:16px; --border:#d7dee9; }
        body { margin:0; font-family:'Segoe UI', system-ui, sans-serif; background:linear-gradient(135deg,#e0f2fe,#ecfeff,#eef2ff); color:#0f172a; }
        .wrap { max-width:1200px; margin:32px auto; padding:0 18px 32px; }
        .panel { background:#fff; border:1px solid var(--border); border-radius:14px; box-shadow:0 18px 40px rgba(15,23,42,0.12); overflow:hidden; }
        .panel-header { padding:16px 20px; background:#f8fafc; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px; }
        .badge { background:#6366f1; color:#fff; padding:8px 12px; border-radius:10px; font-weight:800; }
        .panel-body { padding:22px; display:grid; gap:20px; }
        h2 { margin:0; font-size:1.3rem; }
        h3 { margin:0; font-size:1.05rem; }
        .section { border:1px solid var(--border); padding:18px; border-radius:10px; background:#f8fafc; display:grid; gap:var(--gap); }
        .row { display:grid; gap:var(--gap); grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); }
        .row-wide { display:grid; gap:var(--gap); grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); }
        .row-auth { display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); }
        .card-selector {
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
            gap:12px;
            width:100%;
        }
        .signup-card {
            border-radius:14px;
            border:1px solid #cbd5e1;
            padding:16px;
            background:#fff;
            display:flex;
            flex-direction:column;
            gap:8px;
            text-align:left;
            cursor:pointer;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
            outline:none;
        }
        .signup-card strong {
            font-size:1.05rem;
        }
        .signup-card p {
            margin:0;
            color:#475569;
            font-size:0.95rem;
        }
        .signup-card .card-btn {
            margin-top:auto;
            align-self:flex-start;
            font-size:0.85rem;
            font-weight:700;
            color:#0ea5e9;
        }
        .signup-card.active {
            border-color:#0ea5e9;
            box-shadow:0 12px 25px rgba(14,165,233,0.2);
            transform:translateY(-2px);
        }
        .full { grid-column:1/-1; }
        label { font-weight:700; display:block; font-size:0.95rem; margin-bottom:4px; }
        input, select, textarea { width:100%; padding:12px; border:1px solid #cbd5e1; border-radius:0; background:#fff; font-size:1rem; box-sizing:border-box; }
        textarea { resize:vertical; min-height:90px; }
        .actions { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; }
        .btn { border:none; border-radius:10px; padding:12px 16px; font-weight:800; cursor:pointer; transition:transform 0.1s ease, box-shadow 0.1s ease; }
        .btn-primary { background:linear-gradient(90deg,#22c55e,#16a34a); color:#fff; }
        .btn-secondary { background:linear-gradient(90deg,#0ea5e9,#06b6d4); color:#fff; }
        .btn-danger { background:#f87171; color:#fff; }
        .btn:hover { transform: translateY(-1px); box-shadow:0 10px 18px rgba(15,23,42,0.12); }
        .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#e0f2fe; font-weight:700; font-size:0.9rem; color:#0f172a; }
        .messages { list-style:none; padding:0; margin:0 0 12px; }
        .messages li { background:#fff4e5; color:#b45309; border:1px solid #fcd34d; padding:10px 12px; border-radius:10px; margin-bottom:8px; }
        .child-card { background:#fff; border:1px solid var(--border); padding:18px; border-radius:10px; display:grid; gap:var(--gap); }
        .child-photo-field { display:grid; gap:6px; }
        .child-photo-preview { width:120px; height:160px; border:1px dashed var(--border); border-radius:10px; display:flex; align-items:center; justify-content:center; overflow:hidden; background:#f8fafc; position:relative; }
        .child-photo-preview span { font-size:0.8rem; color:#475569; text-align:center; padding:0 6px; }
        .child-photo-preview img { display:none; width:100%; height:100%; object-fit:cover; }
        .child-photo-note { font-size:0.85rem; color:#475569; }
        .stacked { display:grid; gap:14px; }
        .field-error {
            border-color: #ef4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.25);
        }
        .client-error {
            background: #fee2e2;
            color: #b91c1c;
            border: 1px solid #fecaca;
            border-radius: 10px;
            padding: 10px 12px;
            font-weight: 700;
            margin-bottom: 10px;
            display: none;
        }
        @media (max-width: 720px) {
            .panel-body { padding:14px; }
            .section, .child-card { padding:12px; }
            .actions { flex-direction:column; align-items:flex-start; }
            .btn { width:100%; text-align:center; }
        }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="panel">
            <div class="panel-header">
                <div class="badge">Cadastre-se</div>
                <div style="font-weight:700;">Responsavel + Aventureiros</div>
            </div>
            <div class="panel-body">
                {% if messages %}
                    <ul class="messages">
                        {% for message in messages %}
                            <li>{{ message }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
                <div id="client-validation" class="client-error">Preencha os campos destacados antes de enviar.</div>
                <form method="post" class="stacked" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="signup_type" id="signup-type" value="responsavel">
                    <div class="section">
                        <div class="actions" style="gap:12px; align-items:center;">
                            <h2>Tipo de cadastro</h2>
                            <div class="card-selector">
                                <button type="button" class="signup-card active" data-target="responsavel">
                                    <strong>Responsável</strong>
                                    <p>Caso queira registrar um pai/mãe ou responsável por aventureiros.</p>
                                    <span class="card-btn">Selecionar</span>
                                </button>
                                <button type="button" class="signup-card" data-target="directoria">
                                    <strong>Diretoria / Administrativo</strong>
                                    <p>Use este formulário para cadastrar novos membros da diretoria ou equipe administrativa.</p>
                                    <span class="card-btn">Selecionar</span>
                                </button>
                            </div>
                        </div>
                        <p style="margin:0; color:#475569;">Escolha o tipo de cadastro para exibir os campos corretos.</p>
                    </div>

                    <div id="directoria-section" class="section" style="display:none; gap:14px;">
                        <div class="actions">
                            <h2 style="margin:0;">Diretoria / Administrativo</h2>
                            <span class="pill">Cadastro rápido</span>
                        </div>
                        <div class="row-wide">
                            <div>
                                <label>Nome<input type="text" id="dir-name" name="dir_name" list="directoria-names"></label>
                            </div>
                            <div>
                                <label>Sobrenome<input type="text" name="dir_last"></label>
                            </div>
                            <datalist id="directoria-names">
                                {% for candidate in directoria_candidates %}
                                    <option value="{{ candidate.first_name }} {{ candidate.last_name }}" data-whatsapp="{{ candidate.whatsapp_number }}" data-email="{{ candidate.email }}"></option>
                                {% endfor %}
                            </datalist>
                            <div>
                                <label>WhatsApp<input type="text" id="dir-whatsapp" name="dir_whatsapp"></label>
                            </div>
                            <div>
                                <label>E-mail<input type="email" id="dir-email" name="dir_email"></label>
                            </div>
                            <div>
                                <label>Endereço<input type="text" id="dir-address" name="dir_address"></label>
                            </div>
                        </div>
                        <div class="row-wide">
                            <div>
                                <label>Senha<input type="password" name="dir_password" required></label>
                            </div>
                            <div>
                                <label>Confirme a senha<input type="password" name="dir_password_confirm" required></label>
                            </div>
                        </div>
                        <div>
                            <div style="font-weight:700; margin-bottom:6px;">Perfis</div>
                            <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px;">
                                {% for code,label in role_choices %}
                                    <label style="display:flex; align-items:center; gap:6px;">
                                        <input type="checkbox" name="dir_roles" value="{{ code }}"> {{ label }}
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <div id="responsavel-section">
                        <div class="section">
                            <div class="actions" style="gap:6px;">
                                <h2>Responsavel</h2>
                                <span class="pill">Login</span>
                            </div>
                            <div class="row-wide">
                                <div><label>Nome<input type="text" name="resp_name" required></label></div>
                                <div><label>Sobrenome<input type="text" name="resp_last"></label></div>
                                <div><label>CPF (obrigatorio)<input type="text" name="resp_cpf" required></label></div>
                            </div>
                            <div class="row-wide">
                                <div><label>WhatsApp (login)<input type="text" name="resp_whatsapp" required></label></div>
                                <div><label>WhatsApp financeiro<input type="text" name="resp_fin_whatsapp" placeholder="WhatsApp do responsável financeiro"></label></div>
                                <div><label>Telefone financeiro<input type="text" name="resp_fin_phone" placeholder="Telefone do responsável financeiro"></label></div>
                                <div><label>E-mail<input type="email" name="resp_email"></label></div>
                            </div>
                            <div class="row-wide">
                                <div><label>Endereço<input type="text" name="resp_address"></label></div>
                            </div>
                            <div class="row-wide">
                                <div><label>Senha<input type="password" name="resp_password" required></label></div>
                                <div><label>Repita a senha<input type="password" name="resp_password_confirm" required></label></div>
                            </div>
                        </div>

                        <div class="section" style="gap:14px;">
                            <div class="actions">
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <h2 style="margin:0;">Aventureiros</h2>
                                    <span class="pill">Adicione pelo menos um</span>
                                </div>
                                <button type="button" id="add-child" class="btn btn-secondary">+ Aventureiro</button>
                            </div>
                            <div id="child-rows" class="stacked"></div>
                        </div>
                    </div>

                    <div class="actions" style="justify-content:flex-end; margin-top:4px;">
                        <button type="submit" class="btn btn-primary">Concluir cadastro</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('child-rows');
    const addBtn = document.getElementById('add-child');
    const signupTypeField = document.getElementById('signup-type');
    const directSection = document.getElementById('directoria-section');
    const respSection = document.getElementById('responsavel-section');
    const cards = document.querySelectorAll('[data-target]');
    const dirName = document.getElementById('dir-name');
    const dirWhatsapp = document.getElementById('dir-whatsapp');
    const dirEmail = document.getElementById('dir-email');

    const markOriginalRequired = (section) => {
        section.querySelectorAll('input, select, textarea').forEach((field) => {
            field.dataset.clientRequired = field.required ? 'true' : 'false';
        });
    };

    const toggleSectionFields = (section, active) => {
        section.querySelectorAll('input, select, textarea').forEach((field) => {
            field.disabled = !active;
            if (field.dataset.clientRequired === 'true') {
                field.required = active;
            } else if (!active) {
                field.required = false;
            }
        });
    };

    markOriginalRequired(directSection);
    markOriginalRequired(respSection);

    const setActiveType = (type) => {
        signupTypeField.value = type;
        cards.forEach((button) => {
            button.classList.toggle('active', button.dataset.target === type);
        });
        if (type === 'directoria') {
            directSection.style.display = 'grid';
            respSection.style.display = 'none';
            toggleSectionFields(directSection, true);
            toggleSectionFields(respSection, false);
        } else {
            directSection.style.display = 'none';
            respSection.style.display = 'block';
            toggleSectionFields(directSection, false);
            toggleSectionFields(respSection, true);
        }
    };

    const updateSections = () => {
        setActiveType(signupTypeField.value || 'responsavel');
    };

    cards.forEach((card) => {
        card.addEventListener('click', () => {
            setActiveType(card.dataset.target);
        });
    });
    updateSections();

    if (dirName && dirWhatsapp) {
        const options = document.querySelectorAll('#directoria-names option');
        dirName.addEventListener('input', () => {
            const match = Array.from(options).find((opt) => opt.value === dirName.value);
            if (match) {
                dirWhatsapp.value = match.getAttribute('data-whatsapp') || '';
                if (dirEmail) {
                    dirEmail.value = match.getAttribute('data-email') || '';
                }
            }
        });
    }

    let childIndexCounter = 0;

    function addChild(data={}) {
        const card = document.createElement('div');
        card.className = 'child-card';
        const childIndex = data.idx ?? childIndexCounter++;
        const childData = { ...data, idx: childIndex };
        card.innerHTML = `
            <div class="actions">
                <div style="display:flex; gap:8px; align-items:center;">
                    <h3>Aventureiro</h3>
                    <span class="pill">Dados básicos</span>
                </div>
                <button type="button" class="btn btn-danger btn-sm" style="padding:8px 10px;">Remover</button>
            </div>
            <div class="row-wide">
                <div><label>Nome<input name="child_name" value="${childData.name||''}" required placeholder="Primeiro nome"></label></div>
                <div><label>Sobrenome<input name="child_last" value="${childData.last||''}" placeholder="Sobrenome"></label></div>
                <div><label>Nascimento<input type="date" name="child_birth" value="${childData.birth||''}" required></label></div>
                <div><label>Sexo
                    <select name="child_gender">
                        <option value="">Selecione</option>
                        <option ${childData.gender==='M'?'selected':''} value="M">Masculino</option>
                        <option ${childData.gender==='F'?'selected':''} value="F">Feminino</option>
                    </select>
                </label></div>
                <div><label>CPF (opcional)<input name="child_cpf" value="${childData.cpf||''}"></label></div>
            </div>
            <div class="row-wide">
                <div><label>Certidão de nascimento (se CPF/RG não existir)<input name="child_birth_certificate" value="${childData.birth_cert||''}"></label></div>
            </div>
            <div class="row" style="gap:20px; align-items:flex-end;">
                <div class="child-photo-field">
                    <label>Foto 3x4<input type="file" name="child_photo_${childData.idx}" accept="image/*" capture="environment"></label>
                    <div class="child-photo-note">Selecione um arquivo ou use a câmera do celular/webcam.</div>
                </div>
                <div class="child-photo-preview" data-preview>
                    <span>Prévia 3x4</span>
                    <img alt="Prévia da foto do aventureiro">
                </div>
            </div>
            <div class="row-wide">
                <div><label>Nome completo do pai<input name="child_father_name" value="${childData.father_name||''}"></label></div>
                <div><label>CPF do pai<input name="child_father_cpf" value="${childData.father_cpf||''}"></label></div>
                <div><label>Telefone do pai<input name="child_father_phone" value="${childData.father_phone||''}"></label></div>
                <div>
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" name="child_father_absent" value="${childData.idx}" ${childData.father_absent?'checked':''}> Pai ausente/desconhecido
                    </label>
                </div>
            </div>
            <div class="row-wide">
                <div><label>Nome completo da mae<input name="child_mother_name" value="${childData.mother_name||''}"></label></div>
                <div><label>CPF da mae<input name="child_mother_cpf" value="${childData.mother_cpf||''}"></label></div>
                <div><label>Telefone da mae<input name="child_mother_phone" value="${childData.mother_phone||''}"></label></div>
                <div>
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" name="child_mother_absent" value="${childData.idx}" ${childData.mother_absent?'checked':''}> Mae ausente/desconhecido
                    </label>
                </div>
            </div>
            <div class="row">
                <div><label>Alergias<textarea name="child_allergies" rows="3">${childData.allergies||''}</textarea></label></div>
                <div><label>Medicamentos contínuos<textarea name="child_meds" rows="3">${childData.meds||''}</textarea></label></div>
            </div>
            <div class="row">
                <div><label>Restrições<textarea name="child_restr" rows="3">${childData.restr||''}</textarea></label></div>
                <div><label>Observações<textarea name="child_obs" rows="3">${childData.obs||''}</textarea></label></div>
            </div>
            <div class="row-wide">
                <div><label>Contato emergência<input name="child_emerg" value="${childData.emerg||''}" placeholder="Nome do contato"></label></div>
                <div><label>Fone emergência<input name="child_emerg_phone" value="${childData.emerg_phone||''}" placeholder="WhatsApp do contato"></label></div>
                <div><label>Plano de saúde<input name="child_plan" value="${childData.plan||''}"></label></div>
            </div>
            <div class="row-auth">
                <label style="display:flex; align-items:center; gap:8px;"><input type="checkbox" name="child_auth_activity" value="on" required> Autoriza participação em atividades</label>
                <label style="display:flex; align-items:center; gap:8px;"><input type="checkbox" name="child_auth_medical" value="on" required> Autoriza atendimento médico</label>
                <label style="display:flex; align-items:center; gap:8px;"><input type="checkbox" name="child_auth_rules" value="on" required> Aceita regulamento do clube</label>
            </div>
        `;
        let currentObjectUrl;
        const cleanupPreview = () => {
            if (currentObjectUrl) {
                URL.revokeObjectURL(currentObjectUrl);
                currentObjectUrl = null;
            }
        };
        card.querySelector('.btn-danger').addEventListener('click', () => {
            cleanupPreview();
            card.remove();
        });
        const toggleParentFields = (checkbox, selectors) => {
            if (!checkbox) return;
            const toggle = () => {
                selectors.forEach((field) => {
                    field.disabled = checkbox.checked;
                });
            };
            toggle();
            checkbox.addEventListener('change', toggle);
        };

        toggleParentFields(
            card.querySelector('[name="child_father_absent"]'),
            Array.from(card.querySelectorAll('[name="child_father_name"], [name="child_father_cpf"], [name="child_father_phone"]')),
        );
        toggleParentFields(
            card.querySelector('[name="child_mother_absent"]'),
            Array.from(card.querySelectorAll('[name="child_mother_name"], [name="child_mother_cpf"], [name="child_mother_phone"]')),
        );
        const photoInput = card.querySelector('input[type="file"][name^="child_photo_"]');
        const previewContainer = card.querySelector('.child-photo-preview');
        const previewImage = previewContainer ? previewContainer.querySelector('img') : null;
        const previewPlaceholder = previewContainer ? previewContainer.querySelector('span') : null;
        const updatePhotoPreview = () => {
            if (!photoInput || !previewImage) return;
            const file = photoInput.files && photoInput.files[0];
            if (file) {
                if (currentObjectUrl) {
                    URL.revokeObjectURL(currentObjectUrl);
                }
                currentObjectUrl = URL.createObjectURL(file);
                previewImage.src = currentObjectUrl;
                previewImage.style.display = 'block';
                if (previewPlaceholder) {
                    previewPlaceholder.style.display = 'none';
                }
            } else {
                if (currentObjectUrl) {
                    URL.revokeObjectURL(currentObjectUrl);
                    currentObjectUrl = null;
                }
                previewImage.src = '';
                previewImage.style.display = 'none';
                if (previewPlaceholder) {
                    previewPlaceholder.style.display = 'block';
                }
            }
        };
        if (photoInput) {
            photoInput.addEventListener('change', updatePhotoPreview);
        }
        container.appendChild(card);
    }

    addBtn.addEventListener('click', () => addChild());
    addChild();

    const formElement = document.querySelector('form');
    const clientError = document.getElementById('client-validation');

    const clearValidation = () => {
        const invalids = formElement.querySelectorAll(':invalid');
        if (!invalids.length) {
            clientError.style.display = 'none';
        }
    };

    if (formElement) {
        formElement.addEventListener('submit', (event) => {
            const invalidFields = Array.from(formElement.querySelectorAll(':invalid'));
            if (invalidFields.length) {
                event.preventDefault();
                invalidFields.forEach((field) => field.classList.add('field-error'));
                clientError.textContent = 'Preencha todos os campos obrigatórios destacados.';
                clientError.style.display = 'block';
                invalidFields[0].focus();
            }
        });

        formElement.addEventListener('input', (event) => {
            const target = event.target;
            if (target.classList.contains('field-error') && target.checkValidity()) {
                target.classList.remove('field-error');
                clearValidation();
            }
        });
    }
});
</script>
</body>
</html>
