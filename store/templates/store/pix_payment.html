{% extends "base.html" %}
{% block title %}Pagamento MercadoPago{% endblock %}
{% block menu %}
    <a href="{% url 'dashboard' %}">Início</a>
    <a href="{% url 'store-orders' %}">Pedidos</a>
    <a href="{% url 'logout' %}">Sair</a>
{% endblock %}
{% block content %}
<div class="card">
    <div class="chip">Pagamento PIX</div>
    <p><strong>Pedido:</strong> {{ order.id }} | Total: R$ {{ order.total }}</p>
    {% if mp_payment and mp_payment.qr_code %}
    <div style="display:grid; gap:16px; padding:16px; border-radius:12px; border:1px solid #e2e8f0; background:#f8fafc; margin-bottom:12px;">
        {% if mp_payment.qr_code_base64 %}
        <div style="text-align:center;">
            <img src="data:image/png;base64,{{ mp_payment.qr_code_base64 }}" alt="QR Code PIX" style="max-width:260px; width:100%; height:auto; margin-bottom:10px; border-radius:12px; background:#fff; padding:6px;">
        </div>
        {% endif %}
        <div>
            <p style="margin:0 0 6px;">Código PIX oficial do MercadoPago</p>
            <div style="display:flex; gap:8px; align-items:center;">
                <input type="text" id="mp-code" value="{{ mp_payment.qr_code }}" readonly style="flex:1; padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px; font-family:monospace;">
                <button type="button" id="copy-btn" style="padding:10px 14px; border:none; border-radius:10px; background:#0ea5e9; color:#fff; font-weight:700;">Copiar</button>
            </div>
        </div>
        <p style="margin:0; color:#475569;">Quando o pagamento for aprovado, o webhook do MercadoPago atualiza o pedido automaticamente.</p>
        {% if mp_payment.expiration_date %}
        <p style="margin:0; font-size:0.85rem; color:#475569;">Expira em {{ mp_payment.expiration_date }}</p>
        {% endif %}
    </div>
    {% else %}
    <div style="border:1px solid #fecaca; background:#fff7f5; color:#b91c1c; padding:14px 16px; border-radius:10px; display:flex; align-items:center; gap:12px; margin-bottom:18px;">
        <span style="font-weight:700;">Erro:</span>
        <span>{{ mp_payment_error or 'Não foi possível gerar a cobrança PIX pelo MercadoPago.' }}</span>
    </div>
    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:16px; align-items:center; margin-top:12px;">
        <div style="background:#0f172a; color:#fff; padding:16px; border-radius:12px; text-align:center;">
            <div style="font-weight:800; margin-bottom:8px;">QR Code (placeholder)</div>
            <div style="background:#fff; color:#0f172a; padding:14px; border-radius:10px; font-family:monospace;">
                PIX<br>QR<br>CODE
            </div>
        </div>
        <div>
            <p style="margin:0 0 6px;">Código PIX (copia e cola)</p>
            <div style="display:flex; gap:6px; align-items:center;">
                <input type="text" id="pix-code" value="{{ pix_code }}" readonly style="flex:1; padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px;">
                <button type="button" id="copy-btn" style="padding:10px 12px; border:none; border-radius:10px; background:#0ea5e9; color:#fff; font-weight:700;">Copiar</button>
            </div>
            <p style="margin-top:8px; color:#475569;">Abra seu app bancário, cole o código e confirme o pagamento. Depois clique em Confirmar pagamento.</p>
            <form method="post">
                {% csrf_token %}
                <button type="submit" style="width:100%; padding:12px 14px; border:none; border-radius:12px; background:linear-gradient(90deg,#22c55e,#16a34a); color:#fff; font-weight:800;">Confirmar pagamento</button>
            </form>
        </div>
    </div>
    {% endif %}
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const copyBtn = document.getElementById('copy-btn');
        const codeInput = document.getElementById('mp-code') || document.getElementById('pix-code');
        if (!copyBtn || !codeInput) return;
        copyBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(codeInput.value);
                copyBtn.textContent = 'Copiado!';
                setTimeout(() => copyBtn.textContent = 'Copiar', 1800);
            } catch (err) {
                copyBtn.textContent = 'Erro';
                setTimeout(() => copyBtn.textContent = 'Copiar', 1800);
            }
        });
    });
</script>
{% endblock %}
