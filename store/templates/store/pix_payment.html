{% extends "base.html" %}
{% block title %}Pagamento MercadoPago{% endblock %}
{% block menu %}
    <a href="{% url 'dashboard' %}">Início</a>
    <a href="{% url 'store-orders' %}">Pedidos</a>
    <a href="{% url 'logout' %}">Sair</a>
{% endblock %}
{% block content %}
<div class="card">
    <div class="chip">Pagamento PIX</div>
    <p><strong>Pedido:</strong> {{ order.id }} | Total: R$ {{ order.total }}</p>
    {% if mp_preference %}
    <div style="display:grid; gap:16px; padding:16px; border-radius:12px; border:1px solid #e2e8f0; background:#f8fafc;">
        <div>
            <p style="margin:0 0 6px;">Pagamento criado no MercadoPago para o pedido {{ order.id }}. Use o botão abaixo para abrir a cobrança oficial.</p>
            {% if mp_preference.init_point %}
            <a href="{{ mp_preference.init_point }}" target="_blank" rel="noreferrer" style="display:inline-flex; align-items:center; gap:8px; padding:12px 16px; border-radius:10px; background:#0ea5e9; color:#fff; font-weight:700; text-decoration:none;">Abrir MercadoPago</a>
            {% endif %}
        </div>
        {% if mp_preference.sandbox_init_point %}
        <div style="font-size:0.85rem; color:#475569;">
            Sandbox: <a href="{{ mp_preference.sandbox_init_point }}" target="_blank" rel="noreferrer" style="text-decoration:underline;">abrir link de teste</a>
        </div>
        {% endif %}
        <p style="margin:0; color:#475569;">Após o pagamento aprovado o webhook do MercadoPago atualiza o status automaticamente.</p>
    </div>
    {% else %}
    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:16px; align-items:center; margin-top:12px;">
        <div style="background:#0f172a; color:#fff; padding:16px; border-radius:12px; text-align:center;">
            <div style="font-weight:800; margin-bottom:8px;">QR Code (placeholder)</div>
            <div style="background:#fff; color:#0f172a; padding:14px; border-radius:10px; font-family:monospace;">
                PIX<br>QR<br>CODE
            </div>
        </div>
        <div>
            <p style="margin:0 0 6px;">Código PIX (copia e cola)</p>
            <div style="display:flex; gap:6px; align-items:center;">
                <input type="text" id="pix-code" value="{{ pix_code }}" readonly style="flex:1; padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px;">
                <button type="button" id="copy-btn" style="padding:10px 12px; border:none; border-radius:10px; background:#0ea5e9; color:#fff; font-weight:700;">Copiar</button>
            </div>
            <p style="margin-top:8px; color:#475569;">Abra seu app bancário, cole o código e confirme o pagamento. Depois clique em Confirmar pagamento.</p>
            <form method="post">
                {% csrf_token %}
                <button type="submit" style="width:100%; padding:12px 14px; border:none; border-radius:12px; background:linear-gradient(90deg,#22c55e,#16a34a); color:#fff; font-weight:800;">Confirmar pagamento</button>
            </form>
        </div>
    </div>
    {% endif %}
</div>
{% if not mp_preference %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const copyBtn = document.getElementById('copy-btn');
        const pixInput = document.getElementById('pix-code');
        if (!copyBtn || !pixInput) return;
        copyBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(pixInput.value);
                copyBtn.textContent = 'Copiado!';
                setTimeout(() => copyBtn.textContent = 'Copiar', 1800);
            } catch (err) {
                copyBtn.textContent = 'Erro';
                setTimeout(() => copyBtn.textContent = 'Copiar', 1800);
            }
        });
    });
</script>
{% endif %}
{% endblock %}
